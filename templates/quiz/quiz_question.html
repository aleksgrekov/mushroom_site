{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å - –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã -->
        <div class="col-md-3">
            <div class="card bg-success text-white mb-4">
                <div class="card-body text-center">
                    <h3>{{ correct_answers }}</h3>
                    <p class="mb-0">–ü—Ä–∞–≤–∏–ª—å–Ω–æ</p>
                </div>
            </div>
        </div>
        
        <!-- –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –ø–∞–Ω–µ–ª—å - –≤–æ–ø—Ä–æ—Å -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">–í–æ–ø—Ä–æ—Å {{ current_question }} –∏–∑ {{ total_questions }}</h4>
                        <span class="badge bg-light text-primary fs-6">{{ quiz.name }}</span>
                    </div>
                </div>
                
                <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä -->
                <div class="card-body">
                    <div class="progress mb-4" style="height: 10px;">
                        <div class="progress-bar bg-primary" role="progressbar" 
                             style="width: {{ progress }}%;" 
                             aria-valuenow="{{ progress }}" aria-valuemin="0" aria-valuemax="100">
                        </div>
                    </div>
                    
                    <h5 class="card-title mb-4">{{ question.question_text }}</h5>
                    
                    <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Ç–∏–ø–∞ –≤–æ–ø—Ä–æ—Å–∞ -->
                    {% if question.question_type == 'multiple' %}
                    <div class="alert alert-info py-2 mb-3">
                        <small><strong>üìù –í–æ–ø—Ä–æ—Å —Å –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–º –≤—ã–±–æ—Ä–æ–º:</strong> –í—ã–±–µ—Ä–∏—Ç–µ –≤—Å–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã</small>
                    </div>
                    {% endif %}
                    
                    <div id="answers-container">
                        {% for answer in answers %}
                        <div class="form-check mb-3 answer-option" data-answer-id="{{ answer.id }}">
                            {% if question.question_type == 'multiple' %}
                            <input class="form-check-input" type="checkbox" name="answer" 
                                   id="answer{{ answer.id }}" value="{{ answer.id }}">
                            {% else %}
                            <input class="form-check-input" type="radio" name="answer" 
                                   id="answer{{ answer.id }}" value="{{ answer.id }}">
                            {% endif %}
                            <label class="form-check-label fs-5" for="answer{{ answer.id }}">
                                {{ answer.answer_text }}
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <button id="submit-answer" class="btn btn-primary btn-lg w-100 mt-3" disabled>
                        {% if question.question_type == 'multiple' %}
                        –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
                        {% else %}
                        –û—Ç–≤–µ—Ç–∏—Ç—å
                        {% endif %}
                    </button>
                    
                    <div id="result-feedback" class="mt-3" style="display: none;">
                        <!-- –ó–¥–µ—Å—å –±—É–¥–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å - –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã -->
        <div class="col-md-3">
            <div class="card bg-danger text-white mb-4">
                <div class="card-body text-center">
                    <h3>{{ wrong_answers }}</h3>
                    <p class="mb-0">–û—à–∏–±–∫–∏</p>
                </div>
            </div>
            
            <div class="card bg-info text-white">
                <div class="card-body text-center">
                    <h3>{{ score }}</h3>
                    <p class="mb-0">–ë–∞–ª–ª—ã</p>
                </div>
            </div>

            <!-- –ü–æ–¥—Å–∫–∞–∑–∫–∞ –ø–æ —É—Ä–æ–≤–Ω—è–º -->
            <div class="card mt-4">
                <div class="card-body">
                    <h6>–£—Ä–æ–≤–Ω–∏ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏:</h6>
                    <div class="d-flex flex-column gap-2">
                        <span class="badge bg-success">–ë–∞–∑–æ–≤—ã–π</span>
                        <span class="badge bg-warning text-dark">–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π</span>
                        <span class="badge bg-danger">–≠–∫—Å–ø–µ—Ä—Ç</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const answerOptions = document.querySelectorAll('.answer-option');
    const submitButton = document.getElementById('submit-answer');
    const resultFeedback = document.getElementById('result-feedback');
    const isMultipleChoice = document.querySelector('input[type="checkbox"]') !== null;
    
    console.log('Quiz page loaded'); // –û—Ç–ª–∞–¥–æ—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    
    // –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏, –≤—ã–±—Ä–∞–Ω –ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –æ—Ç–≤–µ—Ç
    function checkIfAnswerSelected() {
        if (isMultipleChoice) {
            const checkedBoxes = document.querySelectorAll('input[type="checkbox"]:checked');
            const isSelected = checkedBoxes.length > 0;
            submitButton.disabled = !isSelected;
            console.log('Multiple choice selected:', checkedBoxes.length); // –û—Ç–ª–∞–¥–∫–∞
        } else {
            const selectedRadio = document.querySelector('input[type="radio"]:checked');
            const isSelected = !!selectedRadio;
            submitButton.disabled = !isSelected;
            console.log('Single choice selected:', isSelected); // –û—Ç–ª–∞–¥–∫–∞
        }
    }
    
    // –í—ã–±–æ—Ä –æ—Ç–≤–µ—Ç–∞
    answerOptions.forEach(option => {
        option.addEventListener('click', function(e) {
            if (e.target.tagName === 'INPUT') return;
            
            const input = this.querySelector('input');
            
            if (isMultipleChoice) {
                input.checked = !input.checked;
                this.classList.toggle('selected', input.checked);
            } else {
                answerOptions.forEach(opt => {
                    opt.classList.remove('selected');
                    opt.querySelector('input').checked = false;
                });
                this.classList.add('selected');
                input.checked = true;
            }
            
            checkIfAnswerSelected();
        });
    });
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –Ω–∞ input
    document.querySelectorAll('.form-check-input').forEach(input => {
        input.addEventListener('click', function(e) {
            e.stopPropagation();
            const option = this.closest('.answer-option');
            
            if (isMultipleChoice) {
                option.classList.toggle('selected', this.checked);
            } else {
                answerOptions.forEach(opt => {
                    opt.classList.remove('selected');
                });
                option.classList.add('selected');
            }
            
            checkIfAnswerSelected();
        });
    });
    
    // –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–≤–µ—Ç–∞
    submitButton.addEventListener('click', function() {
        console.log('Submit button clicked'); // –û—Ç–ª–∞–¥–∫–∞
        
        let selectedAnswers = [];
        
        if (isMultipleChoice) {
            const checkedBoxes = document.querySelectorAll('input[type="checkbox"]:checked');
            checkedBoxes.forEach(checkbox => {
                selectedAnswers.push(checkbox.value);
            });
        } else {
            const selectedRadio = document.querySelector('input[type="radio"]:checked');
            if (selectedRadio) {
                selectedAnswers.push(selectedRadio.value);
            }
        }
        
        console.log('Selected answers:', selectedAnswers); // –û—Ç–ª–∞–¥–∫–∞
        
        if (selectedAnswers.length === 0) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–≤–µ—Ç!');
            return;
        }
        
        // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –∏ –≤–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤
        submitButton.disabled = true;
        answerOptions.forEach(option => {
            option.style.pointerEvents = 'none';
        });
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> –ü—Ä–æ–≤–µ—Ä–∫–∞...';
        
        // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
        const formData = new FormData();
        if (isMultipleChoice) {
            selectedAnswers.forEach(id => {
                formData.append('answer_ids', id);
            });
        } else {
            formData.append('answer_id', selectedAnswers[0]);
        }
        formData.append('question_type', '{{ question.question_type }}');
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å
        fetch('{% url "quiz_check_answer" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: formData
        })
        .then(response => {
            console.log('Response status:', response.status); // –û—Ç–ª–∞–¥–∫–∞
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            console.log('Response data:', data); // –û—Ç–ª–∞–¥–∫–∞
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
            submitButton.innerHTML = '{% if question.question_type == "multiple" %}–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã{% else %}–û—Ç–≤–µ—Ç–∏—Ç—å{% endif %}';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            if (data.is_correct) {
                resultFeedback.innerHTML = `
                    <div class="alert alert-success">
                        <h5>‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ!</h5>
                        <p class="mb-0">+10 –±–∞–ª–ª–æ–≤</p>
                    </div>
                `;
            } else {
                let correctAnswersText = '';
                if (data.correct_answers && data.correct_answers.length > 0) {
                    if (data.correct_answers.length === 1) {
                        correctAnswersText = `<p class="mb-0"><strong>–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç:</strong> ${data.correct_answers[0]}</p>`;
                    } else {
                        correctAnswersText = `<p class="mb-0"><strong>–ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã:</strong> ${data.correct_answers.join(', ')}</p>`;
                    }
                }
                
                resultFeedback.innerHTML = `
                    <div class="alert alert-danger">
                        <h5>‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ</h5>
                        ${correctAnswersText}
                    </div>
                `;
                
                // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
                if (data.correct_answer_ids) {
                    answerOptions.forEach(option => {
                        const answerId = parseInt(option.getAttribute('data-answer-id'));
                        if (data.correct_answer_ids.includes(answerId)) {
                            option.classList.add('correct-highlight');
                        }
                    });
                }
            }
            
            resultFeedback.style.display = 'block';
            
            // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –≤–æ–ø—Ä–æ—Å—É —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                window.location.href = '{% url "quiz_question" %}';
            }, 3000);
        })
        .catch(error => {
            console.error('Error:', error);
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
            submitButton.innerHTML = '{% if question.question_type == "multiple" %}–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã{% else %}–û—Ç–≤–µ—Ç–∏—Ç—å{% endif %}';
            submitButton.disabled = false;
            answerOptions.forEach(option => {
                option.style.pointerEvents = 'auto';
            });
            alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –æ—Ç–≤–µ—Ç–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
        });
    });
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è - –ø—Ä–æ–≤–µ—Ä—è–µ–º, –≤—ã–±—Ä–∞–Ω –ª–∏ –æ—Ç–≤–µ—Ç –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    checkIfAnswerSelected();
});
</script>

<style>
.answer-option {
    padding: 15px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    border: 2px solid transparent;
    margin-bottom: 10px;
}

.answer-option:hover {
    background-color: #f8f9fa;
    transform: translateY(-2px);
}

.answer-option.selected {
    background-color: #e3f2fd !important;
    border-color: #2196f3 !important;
    transform: translateY(-2px);
}

.form-check-input {
    transform: scale(1.2);
    margin-right: 10px;
}

.correct-highlight {
    background-color: #d4edda !important;
    border-color: #c3e6cb !important;
    color: #155724;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7); }
    70% { box-shadow: 0 0 0 10px rgba(40, 167, 69, 0); }
    100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); }
}

.btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}
</style>
{% endblock %}